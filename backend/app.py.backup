"""
Application Flask principale pour le syst√®me EOS
"""
from flask import Flask
from flask_cors import CORS
from extensions import init_extensions, db
from config import Config, setup_logging
import logging
import os
import sys
import codecs




# Configuration de l'encodage par d√©faut
if sys.stdout.encoding != 'utf-8':
    sys.stdout = codecs.getwriter('utf-8')(sys.stdout.buffer, 'strict')
if sys.stderr.encoding != 'utf-8':
    sys.stderr = codecs.getwriter('utf-8')(sys.stderr.buffer, 'strict')

# Configuration du logging
setup_logging()
logger = logging.getLogger(__name__)


def create_app(config_class=Config):
    """Factory pour cr√©er l'application Flask"""
    app = Flask(__name__)
    app.config.from_object(config_class)
    
    # Initialiser les extensions
    init_extensions(app)
    
    # Enregistrement des blueprints - v√©rifiez que tous sont pr√©sents et non comment√©s
    register_vpn_template_routes(app)
    register_export_routes(app)
    register_enqueteurs_routes(app)  # Assurez-vous que cette ligne est pr√©sente
    register_vpn_download_routes(app)
    register_etat_civil_routes(app)
    register_tarification_routes(app)
    register_paiement_routes(app)
    register_enquetes_routes(app)
    register_validation_routes(app)


    
    # Le reste du code...
    
    # Une seule configuration CORS
    CORS(app, resources={
        r"/*": {
            "origins": ["http://localhost:5173", "http://192.168.175.1:5173"],
            "methods": ["GET", "POST", "PUT", "DELETE", "OPTIONS"],
            "allow_headers": ["Content-Type", "Authorization", "X-Requested-With"]
        }
    })
    
    # Assurez-vous que le bloc "with app.app_context()" est pr√©sent
    with app.app_context():
        db.create_all()
    
    @app.after_request
    def after_request(response):
        # Ne pas ajouter d'en-t√™te Origin s'il est d√©j√† pr√©sent
        if 'Access-Control-Allow-Origin' not in response.headers:
            response.headers.add('Access-Control-Allow-Origin', '*')
        
        # Ajouter seulement les autres en-t√™tes
        response.headers.add('Access-Control-Allow-Headers', 'Content-Type,Authorization,X-Requested-With')
        response.headers.add('Access-Control-Allow-Methods', 'GET,PUT,POST,DELETE,OPTIONS')
        response.headers.add('Access-Control-Allow-Credentials', 'true')
        
        return response

    @app.route('/')
    def index():
        """Page d'accueil de l'API"""
        from flask import render_template_string
        html = """
        <!DOCTYPE html>
        <html lang="fr">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>API EOS - Syst√®me de Gestion d'Enqu√™tes</title>
            <style>
                * { margin: 0; padding: 0; box-sizing: border-box; }
                body {
                    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    min-height: 100vh;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    padding: 20px;
                }
                .container {
                    background: white;
                    border-radius: 20px;
                    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                    max-width: 800px;
                    width: 100%;
                    padding: 40px;
                }
                h1 {
                    color: #667eea;
                    font-size: 2.5em;
                    margin-bottom: 10px;
                    text-align: center;
                }
                .subtitle {
                    color: #666;
                    text-align: center;
                    margin-bottom: 30px;
                    font-size: 1.1em;
                }
                .status {
                    background: #d4edda;
                    border: 2px solid #28a745;
                    border-radius: 10px;
                    padding: 15px;
                    margin: 20px 0;
                    text-align: center;
                }
                .endpoint {
                    background: #f8f9fa;
                    padding: 12px 15px;
                    margin: 8px 0;
                    border-radius: 8px;
                    border-left: 4px solid #667eea;
                    font-family: 'Courier New', monospace;
                }
                .footer {
                    margin-top: 30px;
                    text-align: center;
                    color: #666;
                    padding-top: 20px;
                    border-top: 1px solid #ddd;
                }
                a { color: #667eea; text-decoration: none; font-weight: bold; }
                a:hover { text-decoration: underline; }
            </style>
        </head>
        <body>
            <div class="container">
                <h1>üöÄ API EOS</h1>
                <p class="subtitle">Syst√®me de Gestion d'Enqu√™tes</p>
                
                <div class="status">
                    <div style="font-size:2em;margin-bottom:10px;">‚úÖ</div>
                    <strong>Serveur op√©rationnel</strong><br>
                    L'API est en ligne et pr√™te √† recevoir des requ√™tes
                </div>

                <h3 style="color:#667eea;margin:20px 0 10px 0;">üìä Routes Principales</h3>
                <div class="endpoint">GET /api/stats - Statistiques globales</div>
                <div class="endpoint">GET /api/donnees - Liste des donn√©es</div>
                <div class="endpoint">GET /api/enqueteurs - Liste des enqu√™teurs</div>
                <div class="endpoint">GET /api/enquetes/pending - Enqu√™tes en attente</div>
                <div class="endpoint">GET /api/test-cors - Test CORS</div>

                <div class="footer">
                    <p>Pour acc√©der √† l'interface frontend, ouvrez : 
                        <a href="http://localhost:5173" target="_blank">http://localhost:5173</a>
                    </p>
                </div>
            </div>
        </body>
        </html>
        """
        return render_template_string(html)
    
    @app.route('/api')
    def api_info():
        """Informations sur l'API"""
        return jsonify({
            "name": "API EOS",
            "version": "1.0.0",
            "status": "operational",
            "endpoints": {
                "stats": "/api/stats",
                "donnees": "/api/donnees",
                "enqueteurs": "/api/enqueteurs",
                "enquetes": "/api/enquetes/*"
            }
        })
    
    @app.route('/api/test-cors', methods=['GET', 'OPTIONS'])
    def test_cors():
        if request.method == 'OPTIONS':
            return '', 200
        return jsonify({"status": "ok"})

    @app.route('/api/stats', methods=['OPTIONS'])
    def options_stats():
        return '', 200 
    
    @app.route('/api/donnees', methods=['GET'])
    def get_donnees():
        try:
            page = request.args.get('page', 1, type=int)
            per_page = request.args.get('per_page', 500, type=int)
            
            pagination = Donnee.query.paginate(page=page, per_page=per_page, error_out=False)
            donnees = pagination.items
            
            return jsonify({
                "success": True,
                "data": [donnee.to_dict() for donnee in donnees],
                "total": pagination.total,
                "pages": pagination.pages,
                "current_page": page
            })
        except Exception as e:
            return jsonify({
                "success": False,
                "error": str(e)
            }), 500
    @app.route('/api/donnees/<int:donnee_id>/historique', methods=['GET'])
    def get_donnee_historique(donnee_id):
        try:
            donnee = Donnee.query.get_or_404(donnee_id)
            
            # R√©cup√©rer l'historique de l'enqu√™te
            history = donnee.get_history()
            
            # R√©cup√©rer les informations sur les contestations li√©es
            contestations = []
            
            # Si c'est une enqu√™te originale, chercher ses contestations
            if not donnee.est_contestation:
                contestations_data = Donnee.query.filter_by(enquete_originale_id=donnee.id).all()
                for cont in contestations_data:
                    contestations.append({
                        'id': cont.id,
                        'numeroDossier': cont.numeroDossier,
                        'date': cont.date_contestation.strftime('%Y-%m-%d') if cont.date_contestation else None,
                        'motif_code': cont.motif_contestation_code,
                        'motif_detail': cont.motif_contestation_detail,
                        'enqueteur': cont.enqueteurId
                    })
            
            # Si c'est une contestation, chercher l'enqu√™te originale
            enquete_originale = None
            if donnee.est_contestation and donnee.enquete_originale_id:
                original = Donnee.query.get(donnee.enquete_originale_id)
                if original:
                    enquete_originale = {
                        'id': original.id,
                        'numeroDossier': original.numeroDossier,
                        'typeDemande': original.typeDemande,
                        'nom': original.nom,
                        'prenom': original.prenom,
                        'enqueteurId': original.enqueteurId
                    }
            
            # R√©cup√©rer l'historique des modifications (donn√©es enqu√™teur)
            modifications = []
            if donnee.donnee_enqueteur:
                modifications = [{
                    'date': donnee.donnee_enqueteur.updated_at.strftime('%Y-%m-%d %H:%M:%S'),
                    'code_resultat': donnee.donnee_enqueteur.code_resultat,
                    'elements_retrouves': donnee.donnee_enqueteur.elements_retrouves
                }]
            
            return jsonify({
                'success': True,
                'data': {
                    'historique': history,
                    'contestations': contestations,
                    'enquete_originale': enquete_originale,
                    'modifications': modifications,
                    'est_contestation': donnee.est_contestation
                }
            })
            
        except Exception as e:
            logger.error(f"Erreur lors de la r√©cup√©ration de l'historique: {str(e)}")
            return jsonify({
                'success': False,
                'error': str(e)
            }), 500    
    @app.route('/api/contestations/<int:enquete_id>', methods=['GET'])
    def get_contestation_details(enquete_id):
        try:
            donnee = Donnee.query.get_or_404(enquete_id)
            
            if donnee.typeDemande != 'CON':
                return jsonify({
                    'success': False,
                    'error': 'Cette enqu√™te n\'est pas une contestation'
                }), 400
                
            # R√©cup√©rer l'enqu√™te originale si elle existe
            enquete_originale = None
            if donnee.enquete_originale_id:  # CORRECTION ICI: enqueteOriginaleId -> enquete_originale_id
                enquete_originale = Donnee.query.get(donnee.enquete_originale_id)
                
            return jsonify({
                'success': True,
                'data': {
                    'contestation': donnee.to_dict(),
                    'enquete_originale': enquete_originale.to_dict() if enquete_originale else None,
                    'enqueteur_id': enquete_originale.enqueteurId if enquete_originale else None,
                    'motif_contestation': donnee.motifDeContestation
                }
            })
        except Exception as e:
            return jsonify({
                'success': False,
                'error': str(e)
            }), 500
    @app.route('/api/donnees/<int:id>', methods=['DELETE'])
    def delete_donnee(id):
        try:
            donnee = Donnee.query.get_or_404(id)
            db.session.delete(donnee)
            db.session.commit()
            return jsonify({'message': 'Enregistrement supprim√© avec succ√®s'}), 200
        except Exception as e:
            db.session.rollback()
            logger.error(f"Erreur lors de la suppression : {str(e)}")
            return jsonify({'error': 'Erreur lors de la suppression'}), 500

    @app.route('/api/donnees', methods=['POST'])
    def add_donnee():
        try:
            data = request.json
            nouvelle_donnee = Donnee(
                numeroDossier=data.get('numeroDossier'),
                referenceDossier=data.get('referenceDossier'),
                typeDemande=data.get('typeDemande'),
                nom=data.get('nom'),
                prenom=data.get('prenom'),
                dateNaissance=datetime.strptime(data.get('dateNaissance'), '%Y-%m-%d').date() if data.get('dateNaissance') else None,
                lieuNaissance=data.get('lieuNaissance'),
                codePostal=data.get('codePostal'),
                ville=data.get('ville'),
                adresse1=data.get('adresse1'),
                adresse2=data.get('adresse2'),
                adresse3=data.get('adresse3'),
                telephonePersonnel=data.get('telephonePersonnel'),
                elementDemandes=data.get('elementDemandes', 'AT'),
                elementObligatoires=data.get('elementObligatoires', 'A')
            )
            db.session.add(nouvelle_donnee)
            db.session.commit()
            
            # Cr√©er automatiquement une entr√©e dans DonneeEnqueteur
            new_donnee_enqueteur = DonneeEnqueteur(
                donnee_id=nouvelle_donnee.id
            )
            db.session.add(new_donnee_enqueteur)
            db.session.commit()
            
            return jsonify({
                'success': True,
                'message': 'Donn√©es ajout√©es avec succ√®s',
                'data': nouvelle_donnee.to_dict()
            }), 201
        except Exception as e:
            db.session.rollback()
            return jsonify({
                'success': False,
                'error': str(e)
            }), 500

    @app.route('/api/donnees-enqueteur/<int:donnee_id>', methods=['GET'])
    def get_donnee_enqueteur(donnee_id):
        try:
            # R√©cup√©rer les donn√©es enqu√™teur
            donnee_enqueteur = DonneeEnqueteur.query.filter_by(donnee_id=donnee_id).first()
            
            if not donnee_enqueteur:
                return jsonify({
                    'success': False, 
                    'error': 'Aucune donn√©e enqu√™teur trouv√©e pour cet ID'
                }), 404
                
            return jsonify({
                'success': True, 
                'data': donnee_enqueteur.to_dict()
            })
            
        except Exception as e:
            logger.error(f"Erreur lors de la r√©cup√©ration des donn√©es enqu√™teur: {str(e)}")
            return jsonify({
                'success': False, 
                'error': str(e)
            }), 500



    @app.route('/api/donnees-complete', methods=['GET'])
    def get_donnees_complete():
        try:
            # Requ√™te avec jointure pour r√©cup√©rer les donn√©es et les infos enqu√™teurs en une seule fois
            donnees = db.session.query(Donnee).options(
                db.joinedload(Donnee.donnee_enqueteur)
            ).all()
            
            result = []
            for donnee in donnees:
                donnee_dict = donnee.to_dict()
                if donnee.donnee_enqueteur:
                    # Ajouter les donn√©es de l'enqu√™teur au dictionnaire
                    # en excluant les cl√©s qui existent d√©j√†
                    for k, v in donnee.donnee_enqueteur.to_dict().items():
                        if k not in ['id', 'donnee_id']:
                            donnee_dict[k] = v
                result.append(donnee_dict)
                
            return jsonify({
                "success": True,
                "data": result
            })
        except Exception as e:
            return jsonify({
                "success": False,
                "error": str(e)
            }), 500
        
    @app.route('/api/donnees-enqueteur/<int:donnee_id>', methods=['POST'])
    def update_donnee_enqueteur(donnee_id):
        try:
            data = request.get_json()
            logger.info(f"Donn√©es re√ßues pour mise √† jour: {data}")
            
            # R√©cup√©rer l'entr√©e existante ou en cr√©er une nouvelle
            donnee_enqueteur = DonneeEnqueteur.query.filter_by(donnee_id=donnee_id).first()
            if not donnee_enqueteur:
                donnee_enqueteur = DonneeEnqueteur(donnee_id=donnee_id)
                db.session.add(donnee_enqueteur)
            
            # Mettre √† jour tous les champs re√ßus
            if 'code_resultat' in data:
                donnee_enqueteur.code_resultat = data.get('code_resultat')
            if 'elements_retrouves' in data:
                donnee_enqueteur.elements_retrouves = data.get('elements_retrouves')
            if 'flag_etat_civil_errone' in data:
                donnee_enqueteur.flag_etat_civil_errone = data.get('flag_etat_civil_errone')
            
            # Adresse
            if 'adresse1' in data:
                donnee_enqueteur.adresse1 = data.get('adresse1')
            if 'adresse2' in data:
                donnee_enqueteur.adresse2 = data.get('adresse2')
            if 'adresse3' in data:
                donnee_enqueteur.adresse3 = data.get('adresse3')
            if 'adresse4' in data:
                donnee_enqueteur.adresse4 = data.get('adresse4')
            if 'code_postal' in data:
                donnee_enqueteur.code_postal = data.get('code_postal')
            if 'ville' in data:
                donnee_enqueteur.ville = data.get('ville')
            if 'pays_residence' in data:
                donnee_enqueteur.pays_residence = data.get('pays_residence')
            if 'telephone_personnel' in data:
                donnee_enqueteur.telephone_personnel = data.get('telephone_personnel')
            if 'telephone_chez_employeur' in data:
                donnee_enqueteur.telephone_chez_employeur = data.get('telephone_chez_employeur')
            
            # Employeur
            if 'nom_employeur' in data:
                donnee_enqueteur.nom_employeur = data.get('nom_employeur')
            if 'telephone_employeur' in data:
                donnee_enqueteur.telephone_employeur = data.get('telephone_employeur')
            if 'telecopie_employeur' in data:
                donnee_enqueteur.telecopie_employeur = data.get('telecopie_employeur')
            if 'adresse1_employeur' in data:
                donnee_enqueteur.adresse1_employeur = data.get('adresse1_employeur')
            if 'adresse2_employeur' in data:
                donnee_enqueteur.adresse2_employeur = data.get('adresse2_employeur')
            if 'adresse3_employeur' in data:
                donnee_enqueteur.adresse3_employeur = data.get('adresse3_employeur')
            if 'adresse4_employeur' in data:
                donnee_enqueteur.adresse4_employeur = data.get('adresse4_employeur')
            if 'code_postal_employeur' in data:
                donnee_enqueteur.code_postal_employeur = data.get('code_postal_employeur')
            if 'ville_employeur' in data:
                donnee_enqueteur.ville_employeur = data.get('ville_employeur')
            if 'pays_employeur' in data:
                donnee_enqueteur.pays_employeur = data.get('pays_employeur')
            
            # Banque
            if 'banque_domiciliation' in data:
                donnee_enqueteur.banque_domiciliation = data.get('banque_domiciliation')
            if 'libelle_guichet' in data:
                donnee_enqueteur.libelle_guichet = data.get('libelle_guichet')
            if 'titulaire_compte' in data:
                donnee_enqueteur.titulaire_compte = data.get('titulaire_compte')
            if 'code_banque' in data:
                donnee_enqueteur.code_banque = data.get('code_banque')
            if 'code_guichet' in data:
                donnee_enqueteur.code_guichet = data.get('code_guichet')
            
            # D√©c√®s
            if 'date_deces' in data:
                donnee_enqueteur.date_deces = datetime.strptime(data.get('date_deces'), '%Y-%m-%d').date() if data.get('date_deces') else None
            if 'numero_acte_deces' in data:
                donnee_enqueteur.numero_acte_deces = data.get('numero_acte_deces')
            if 'code_insee_deces' in data:
                donnee_enqueteur.code_insee_deces = data.get('code_insee_deces')
            if 'code_postal_deces' in data:
                donnee_enqueteur.code_postal_deces = data.get('code_postal_deces')
            if 'localite_deces' in data:
                donnee_enqueteur.localite_deces = data.get('localite_deces')
            
            # Revenus
            if 'commentaires_revenus' in data:
                donnee_enqueteur.commentaires_revenus = data.get('commentaires_revenus')
            
            # Gestion des montants (avec conversion en decimal)
            if 'montant_salaire' in data:
                montant = data.get('montant_salaire')
                donnee_enqueteur.montant_salaire = float(montant) if montant else None
            
            # P√©riodes et fr√©quences
            if 'periode_versement_salaire' in data:
                donnee_enqueteur.periode_versement_salaire = data.get('periode_versement_salaire')
            if 'frequence_versement_salaire' in data:
                donnee_enqueteur.frequence_versement_salaire = data.get('frequence_versement_salaire')

            # Autres revenus
            if 'nature_revenu1' in data:
                donnee_enqueteur.nature_revenu1 = data.get('nature_revenu1')
            if 'montant_revenu1' in data:
                montant = data.get('montant_revenu1')
                donnee_enqueteur.montant_revenu1 = float(montant) if montant else None
            if 'periode_versement_revenu1' in data:
                donnee_enqueteur.periode_versement_revenu1 = data.get('periode_versement_revenu1')
            if 'frequence_versement_revenu1' in data:
                donnee_enqueteur.frequence_versement_revenu1 = data.get('frequence_versement_revenu1')
                
            if 'nature_revenu2' in data:
                donnee_enqueteur.nature_revenu2 = data.get('nature_revenu2')
            if 'montant_revenu2' in data:
                montant = data.get('montant_revenu2')
                donnee_enqueteur.montant_revenu2 = float(montant) if montant else None
            if 'periode_versement_revenu2' in data:
                donnee_enqueteur.periode_versement_revenu2 = data.get('periode_versement_revenu2')
            if 'frequence_versement_revenu2' in data:
                donnee_enqueteur.frequence_versement_revenu2 = data.get('frequence_versement_revenu2')
                
            if 'nature_revenu3' in data:
                donnee_enqueteur.nature_revenu3 = data.get('nature_revenu3')
            if 'montant_revenu3' in data:
                montant = data.get('montant_revenu3')
                donnee_enqueteur.montant_revenu3 = float(montant) if montant else None
            if 'periode_versement_revenu3' in data:
                donnee_enqueteur.periode_versement_revenu3 = data.get('periode_versement_revenu3')
            if 'frequence_versement_revenu3' in data:
                donnee_enqueteur.frequence_versement_revenu3 = data.get('frequence_versement_revenu3')
            
            # M√©mos
            if 'memo1' in data:
                donnee_enqueteur.memo1 = data.get('memo1')
            if 'memo2' in data:
                donnee_enqueteur.memo2 = data.get('memo2')
            if 'memo3' in data:
                donnee_enqueteur.memo3 = data.get('memo3')
            if 'memo4' in data:
                donnee_enqueteur.memo4 = data.get('memo4')
            if 'memo5' in data:
                donnee_enqueteur.memo5 = data.get('memo5')
            
            # Notes personnelles (nouveau champ)
            if 'notes_personnelles' in data:
                donnee_enqueteur.notes_personnelles = data.get('notes_personnelles')
            
            # Mise √† jour de la date de modification
            donnee_enqueteur.updated_at = datetime.utcnow()
            
            db.session.commit()
            
            # Si le code r√©sultat est positif ou confirm√©, calculer la facturation
            if donnee_enqueteur.code_resultat :
                try:
                    # Importer ici pour √©viter des probl√®mes d'import circulaire
                    from services.tarification_service import TarificationService
                    
                    # Forcer les valeurs pour d√©boguer
                    from models.tarifs import EnqueteFacturation
                    
                    # V√©rifier si une facturation existe d√©j√†
                    existing = EnqueteFacturation.query.filter_by(donnee_enqueteur_id=donnee_enqueteur.id).first()
                    if existing:
                        # Mettre √† jour les valeurs cl√©s
                        existing.paye = False  # S'assurer que c'est bien non pay√©
                        if not existing.resultat_enqueteur_montant or existing.resultat_enqueteur_montant <= 0:
                            existing.resultat_enqueteur_montant = 10.0  # Valeur par d√©faut en cas de probl√®me
                            logger.info(f"Montant forc√© √† 10‚Ç¨ pour facturation {existing.id}")
                        db.session.commit()
                        logger.info(f"Facturation existante mise √† jour: {existing.id}")
                    else:
                        # Calculer normalement
                        facturation = TarificationService.calculate_tarif_for_enquete(donnee_enqueteur.id)
                        if facturation:
                            # Double v√©rification
                            if not facturation.resultat_enqueteur_montant or facturation.resultat_enqueteur_montant <= 0:
                                facturation.resultat_enqueteur_montant = 10.0
                                db.session.commit()
                            logger.info(f"Facturation cr√©√©e avec succ√®s: {facturation.id}, montant: {facturation.resultat_enqueteur_montant}‚Ç¨")
                        else:
                            logger.error(f"√âchec de cr√©ation de facturation pour l'enqu√™te {donnee_id}")
                except Exception as e:
                    logger.error(f"Erreur lors du calcul de la facturation: {str(e)}")
                                    
            return jsonify({
                'success': True, 
                'message': 'Donn√©es mises √† jour avec succ√®s',
                'data': donnee_enqueteur.to_dict()
            })
            
        except Exception as e:
            db.session.rollback()
            logger.error(f"Erreur lors de la mise √† jour des donn√©es enqu√™teur: {str(e)}")
            return jsonify({
                'success': False, 
                'error': str(e)
            }), 400
    @app.route('/api/fix-facturations', methods=['POST'])
    def fix_facturations():
        """API pour corriger les associations enqu√™teur-facturation existantes"""
        try:
            # R√©cup√©rer toutes les facturations sans enqu√™teur
            facturations = db.session.query(
                EnqueteFacturation, Donnee
            ).join(
                Donnee, EnqueteFacturation.donnee_id == Donnee.id
            ).filter(
                Donnee.enqueteurId.is_(None),
                EnqueteFacturation.resultat_enqueteur_montant > 0
            ).all()
            
            fixed_count = 0
            
            # Pour chaque facturation, assigner un enqu√™teur
            for facturation, donnee in facturations:
                # Pour ce test, assignons l'enqu√™teur ID 1 √† toutes les enqu√™tes
                # Dans un cas r√©el, vous devriez avoir une logique plus complexe
                donnee.enqueteurId = 1
                fixed_count += 1
            
            db.session.commit()
            
            return jsonify({
                'success': True,
                'message': f'Corrections effectu√©es: {fixed_count} facturations',
                'count': fixed_count
            })
        except Exception as e:
            db.session.rollback()
            return jsonify({
                'success': False,
                'error': str(e)
            }), 500
    @app.route('/api/assign-enquete', methods=['POST'])
    def assign_enquete():
        try:
            data = request.json
            logger.info(f"Donn√©es re√ßues pour l'assignation: {data}")
            
            enquete_id = data.get('enqueteId')
            enqueteur_id = data.get('enqueteurId')
            
            logger.info(f"Tentative d'assignation de l'enqu√™te {enquete_id} √† l'enqu√™teur {enqueteur_id}")
            
            if not enquete_id:
                logger.error("Erreur: enqueteId manquant")
                return jsonify({'success': False, 'error': 'Missing enqueteId'}), 400
                
            # MODIFICATION ICI: Chercher par ID ou numeroDossier
            enquete = None
            try:
                # Essayer d'abord par ID
                enquete_id_int = int(enquete_id)
                enquete = Donnee.query.filter_by(id=enquete_id_int).first()
            except ValueError:
                # Si ce n'est pas un entier, chercher par numeroDossier
                pass
                
            if not enquete:
                enquete = Donnee.query.filter_by(numeroDossier=enquete_id).first()
                
            if not enquete:
                logger.error(f"Erreur: enqu√™te {enquete_id} non trouv√©e")
                return jsonify({'success': False, 'error': 'Enqu√™te not found'}), 404
                
            if enqueteur_id:
                enqueteur = Enqueteur.query.get(enqueteur_id)
                if not enqueteur:
                    logger.error(f"Erreur: enqu√™teur {enqueteur_id} non trouv√©")
                    return jsonify({'success': False, 'error': 'Enqu√™teur not found'}), 404
                logger.info(f"Enqu√™teur trouv√©: {enqueteur.nom}")
            
            logger.info(f"Assignation de l'enqu√™te {enquete_id} √† l'enqu√™teur {enqueteur_id}")
            enquete.enqueteurId = enqueteur_id if enqueteur_id != '' else None
            db.session.commit()
            logger.info("Assignation r√©ussie")
            
            # AJOUT ICI: Recalculer la facturation si l'enqu√™te est d√©j√† trait√©e
            donnee_enqueteur = DonneeEnqueteur.query.filter_by(donnee_id=enquete.id).first()
            if donnee_enqueteur and donnee_enqueteur.code_resultat in ['P', 'H']:
                try:
                    from services.tarification_service import TarificationService
                    TarificationService.calculate_tarif_for_enquete(donnee_enqueteur.id)
                    logger.info(f"Facturation recalcul√©e apr√®s assignation pour l'enqu√™te {enquete.id}")
                except Exception as e:
                    logger.error(f"Erreur lors du recalcul de la facturation: {str(e)}")
            
            return jsonify({
                'success': True,
                'message': 'Assignment successful',
                'data': enquete.to_dict()
            }), 200
        except Exception as e:
            logger.error(f"Erreur lors de l'assignation: {str(e)}")
            db.session.rollback()
            return jsonify({
                'success': False,
                'error': str(e)
            }), 500

    @app.route('/api/enqueteurs-stats', methods=['GET'])
    def get_enqueteurs_stats():
        """Obtenir des statistiques sur les enqu√™teurs et leurs enqu√™tes assign√©es"""
        try:
            # R√©cup√©rer tous les enqu√™teurs
            enqueteurs = Enqueteur.query.all()
            
            stats = []
            for enqueteur in enqueteurs:
                # Compter les enqu√™tes assign√©es √† cet enqu√™teur
                total_enquetes = Donnee.query.filter_by(enqueteurId=enqueteur.id).count()
                
                # Compter les enqu√™tes par statut
                from sqlalchemy import func
                status_counts = (db.session.query(
                    DonneeEnqueteur.code_resultat, 
                    func.count(DonneeEnqueteur.id)
                )
                .join(Donnee, Donnee.id == DonneeEnqueteur.donnee_id)
                .filter(Donnee.enqueteurId == enqueteur.id)
                .group_by(DonneeEnqueteur.code_resultat)
                .all())
                
                # Convertir les r√©sultats en dictionnaire
                status_dict = {
                    'P': 0,  # Positif
                    'N': 0,  # N√©gatif
                    'H': 0,  # Confirm√©
                    'Z': 0,  # Annul√© agence
                    'I': 0,  # Intraitable
                    'Y': 0,  # Annul√© EOS
                    'pending': 0  # En attente de traitement
                }
                
                for status, count in status_counts:
                    if status:
                        status_dict[status] = count
                
                # Calculer les enqu√™tes en attente
                status_dict['pending'] = total_enquetes - sum(status_dict.values())
                
                stats.append({
                    'id': enqueteur.id,
                    'nom': enqueteur.nom,
                    'prenom': enqueteur.prenom,
                    'email': enqueteur.email,
                    'total_enquetes': total_enquetes,
                    'statuts': status_dict
                })
            
            return jsonify({
                'success': True,
                'data': stats
            })
            
        except Exception as e:
            logger.error(f"Erreur lors de la r√©cup√©ration des statistiques: {str(e)}")
            return jsonify({
                'success': False,
                'error': str(e)
            }), 500

    @app.route('/parse', methods=['POST'])
    def parse_file():
        logger.info("D√©but du traitement de la requ√™te d'import")
        try:
            if 'file' not in request.files:
                return jsonify({"error": "Aucun fichier fourni"}), 400
                
            file = request.files['file']
            if not file.filename:
                return jsonify({"error": "Nom de fichier invalide"}), 400

            # V√©rifier si le fichier existe d√©j√†
            existing_file = Fichier.query.filter_by(nom=file.filename).first()
            if existing_file:
                return jsonify({
                    "status": "file_exists",
                    "message": "Ce fichier existe d√©j√†. Voulez-vous le remplacer ?",
                    "existing_file_info": {
                        "nom": existing_file.nom,
                        "date_upload": existing_file.date_upload.strftime('%Y-%m-%d %H:%M:%S'),
                        "nombre_donnees": Donnee.query.filter_by(fichier_id=existing_file.id).count()
                    }
                }), 409

            # 1. Lire le contenu du fichier
            content = file.read()
            if not content:
                return jsonify({"error": "Fichier vide"}), 400

            try:
                # 2. Cr√©er d'abord l'entr√©e du fichier
                nouveau_fichier = Fichier(nom=file.filename)
                db.session.add(nouveau_fichier)
                db.session.commit()
                logger.info(f"Fichier cr√©√© avec ID: {nouveau_fichier.id}")

                # 3. Traiter le contenu avec l'ID du fichier
                from utils import process_file_content
                processed_records = process_file_content(content, nouveau_fichier.id)
                
                if processed_records:
                    return jsonify({
                        "message": "Fichier trait√© avec succ√®s",
                        "file_id": nouveau_fichier.id,
                        "records_processed": len(processed_records)
                    })
                else:
                    # Si aucun enregistrement n'a √©t√© cr√©√©, on supprime le fichier
                    db.session.delete(nouveau_fichier)
                    db.session.commit()
                    return jsonify({"error": "Aucun enregistrement valide trouv√© dans le fichier"}), 400

            except Exception as e:
                # En cas d'erreur, on s'assure de supprimer le fichier s'il a √©t√© cr√©√©
                if 'nouveau_fichier' in locals():
                    try:
                        db.session.delete(nouveau_fichier)
                        db.session.commit()
                    except:
                        db.session.rollback()
                
                logger.error(f"Erreur lors du traitement du contenu: {str(e)}")
                return jsonify({"error": str(e)}), 400

        except Exception as e:
            logger.error(f"Erreur lors du traitement: {str(e)}")
            return jsonify({"error": str(e)}), 500

    @app.route('/replace-file', methods=['POST'])
    def replace_file():
        try:
            if 'file' not in request.files:
                return jsonify({"error": "Aucun fichier fourni"}), 400
                
            file = request.files['file']
            if not file.filename:
                return jsonify({"error": "Nom de fichier invalide"}), 400

            # Supprimer l'ancien fichier et ses donn√©es
            existing_file = Fichier.query.filter_by(nom=file.filename).first()
            if existing_file:
                Donnee.query.filter_by(fichier_id=existing_file.id).delete()
                db.session.delete(existing_file)
                db.session.commit()

            # Cr√©er le nouveau fichier
            nouveau_fichier = Fichier(nom=file.filename)
            db.session.add(nouveau_fichier)
            db.session.commit()
            
            content = file.read()
            from utils import process_file_content
            processed_records = process_file_content(content, nouveau_fichier.id)

            return jsonify({
                "message": "Fichier remplac√© avec succ√®s",
                "file_id": nouveau_fichier.id,
                "records_processed": len(processed_records)
            })

        except Exception as e:
            logger.error(f"Erreur lors du remplacement: {str(e)}")
            return jsonify({"error": str(e)}), 500

    @app.route('/api/stats', methods=['GET'])
    def get_stats():
        try:
            total_fichiers = Fichier.query.count()
            total_donnees = Donnee.query.count()
            
            derniers_fichiers = (Fichier.query
                            .order_by(Fichier.date_upload.desc())
                            .all())
            
            fichiers_info = [{
                "id": f.id,
                "nom": f.nom,
                "date_upload": f.date_upload.strftime('%Y-%m-%d %H:%M:%S'),
                "nombre_donnees": Donnee.query.filter_by(fichier_id=f.id).count()
            } for f in derniers_fichiers]
            
            logger.info(f"Stats - Fichiers: {total_fichiers}, Donn√©es: {total_donnees}")
            return jsonify({
                "total_fichiers": total_fichiers,
                "total_donnees": total_donnees,
                "derniers_fichiers": fichiers_info
            })
            
        except Exception as e:
            logger.error(f"Erreur dans get_stats: {str(e)}")
            return jsonify({"error": str(e)}), 500

    @app.route('/api/files/<int:file_id>', methods=['DELETE'])
    def delete_file(file_id):
        try:
            logger.info(f"Tentative de suppression du fichier {file_id}")
            fichier = Fichier.query.get_or_404(file_id)
            
            # Supprimer d'abord toutes les donn√©es associ√©es
            try:
                Donnee.query.filter_by(fichier_id=file_id).delete()
                logger.info(f"Donn√©es du fichier {file_id} supprim√©es")
            except Exception as e:
                logger.error(f"Erreur lors de la suppression des donn√©es: {e}")
                db.session.rollback()
                return jsonify({"error": "Erreur lors de la suppression des donn√©es"}), 500
            
            # Supprimer le fichier
            try:
                db.session.delete(fichier)
                db.session.commit()
                logger.info(f"Fichier {file_id} supprim√© avec succ√®s")
            except Exception as e:
                logger.error(f"Erreur lors de la suppression du fichier: {e}")
                db.session.rollback()
                return jsonify({"error": "Erreur lors de la suppression du fichier"}), 500
            
            return jsonify({"message": "Fichier supprim√© avec succ√®s"}), 200
            
        except Exception as e:
            logger.error(f"Erreur g√©n√©rale lors de la suppression: {e}")
            return jsonify({"error": str(e)}), 500

    logger.info("Routes legacy enregistr√©es")


if __name__ == '__main__':
    app = create_app()
    app.run(host='0.0.0.0', port=5000, debug=True)
